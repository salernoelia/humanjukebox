<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.0/addons/p5.dom.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js"
      type="text/javascript"
    ></script>

    <meta charset="utf-8" />
  </head>
  <body>
    <script>
      let handData = { value: {} };
      let leftHandIndexX = { value: 0 };
      let leftHandIndexY = { value: 0 };
      let leftHandIndexZ = { value: 0 };
      let rightHandIndexX = { value: 0 };
      let rightHandIndexY = { value: 0 };
      let rightHandIndexZ = { value: 0 };
      let leftHandThumbX = { value: 0 };
      let leftHandThumbY = { value: 0 };
      let leftHandThumbZ = { value: 0 };
      let rightHandThumbX = { value: 0 };
      let rightHandThumbY = { value: 0 };
      let rightHandThumbZ = { value: 0 };

      const ws = new WebSocket("ws://localhost:8081");

      ws.onopen = () => {
        console.log("Connected to WebSocket server");
      };

      ws.onmessage = async function (event) {
        const parsedData = JSON.parse(event.data);
        console.log(parsedData); // Check the received data structure
      
        const hand = parsedData.hand;
        const indexX = parsedData[`${hand}-index`].x;
        const indexY = parsedData[`${hand}-index`].y;
        const indexZ = parsedData[`${hand}-index`].z;
        const thumbX = parsedData[`${hand}-thumb`].x;
        const thumbY = parsedData[`${hand}-thumb`].y;
        const thumbZ = parsedData[`${hand}-thumb`].z;
      
        // Update your UI or do whatever you need with the data here
        if (hand === "right") {
          leftHandIndexX.value = indexX;
          leftHandIndexY.value = indexY;
          leftHandIndexZ.value = indexZ;
          leftHandThumbX.value = thumbX;
          leftHandThumbY.value = thumbY;
          leftHandThumbZ.value = thumbZ;
        } else if (hand === "left") {
          rightHandIndexX.value = indexX;
          rightHandIndexY.value = indexY;
          rightHandIndexZ.value = indexZ;
          rightHandThumbX.value = thumbX;
          rightHandThumbY.value = thumbY;
          rightHandThumbZ.value = thumbZ;
        }
      
        return (
          leftHandIndexX.value,
          leftHandIndexY.value,
          leftHandIndexZ.value,
          rightHandIndexX.value,
          rightHandIndexY.value,
          rightHandIndexZ.value,
          leftHandThumbX.value,
          leftHandThumbY.value,
          leftHandThumbZ.value,
          rightHandThumbX.value,
          rightHandThumbY.value,
          rightHandThumbZ.value
        );
      };

      ws.onerror = (error) => {
        console.error("WebSocket error: ", error);
      };

      ws.onclose = () => {
        console.log("WebSocket connection closed");
      };

      Tone.Master.volume.value = -10;
      let bandpass = new Tone.Filter({
        type: "bandpass",
        frequency: 300,
        Q: 1,
      }).toMaster();

      let synth = new Tone.DuoSynth({
        envelope: {
          attack: 0.01,
          decay: 0.1,
          sustain: 0.6,
          release: 1,
        },
      }).connect(bandpass);
      synth.volume.value = -10;

      const filter = new Tone.AutoFilter({
        frequency: 5,
        depth: 0.9,
      })
        .toMaster()
        .start();

      let lowpass = new Tone.Filter({
        type: "lowpass",
        frequency: 150,
        Q: 1,
      }).connect(filter);

      let monoSynth = new Tone.PolySynth({
        maxPolyphony: 4,
        oscillator: {
          type: "sawtooth",
        },
        envelope: {
          attack: 0.01,
          decay: 0.1,
          sustain: 0.6,
          release: 1,
        },
        portamento: 0.05,
      }).connect(lowpass);

      let generateButton;
      let playButton;

      let root = 48;
      let scale = [
        [0, 2, 4, 5, 7, 9, 11, 12], //Dur Major
      ];

      let scaleNames = ["Major"];

      let selectedScale = scale[0];
      let selectScale;
      let numNotes = 8;
      let melody = [];

      let beat;
      let prevX;
      let prevY;

      let n;
      let note;

      let pt = [];
      let x = 8;
      let y = 192;

      function preload() {
        selectedScale = 0;
      }

      function setup() {
        createCanvas(window.innerWidth, window.innerHeight);
        background(150);
        generateMelody();
        setTimeSig(8);
        generateButton = createButton("random");
        generateButton.position(0, 10);
        generateButton.mousePressed(generateMelody);

        playButton = createButton("play");
        playButton.position(60, 10);
        playButton.mousePressed(playMelody);
      }

      function draw() {
        x = map(rightHandIndexX.value, 1, 0, 0, window.innerWidth);
        y = map(rightHandIndexY.value, 0, 1, 0, window.innerHeight);
        fill(255);
        ellipse(x, y, 50, 50);
        // Delete this if block @Elia
        if (prevX !== undefined && prevY !== undefined) {
          stroke("white");
          strokeWeight(2);
          line(prevX, prevY, rightHandIndexX.value, rightHandIndexY.value);
        }

        prevX = rightHandIndexX.value;
        prevY = rightHandIndexY.value;
        //--------

        let lowpassFreq = map(y, window.innerHeight, 0, 200, 1000);
        lowpass.frequency.value = lowpassFreq;

        let bandpassFreq = map(y, window.innerHeight, 0, 250, 400);
        bandpass.frequency.value = bandpassFreq;

        const lfoFrequency = map(x, 0, window.innerWidth, 0, 10);
        filter.frequency.value = lfoFrequency;
      }

      function thisScale() {
        selectedScale = selectScale.value();
        generateMelody();
      }

      function melodyIndex(note) {
        let melIndex = note - root;
        return scale[selectedScale].indexOf(melIndex);
      }

      function setTimeSig(ts) {
        Tone.Transport.timeSignature = [ts, 4];
      }

      // Start & Stop isch e chli am inneschisse
      function playMelody() {
        if (Tone.Transport.state == "started") {
          background("black");
          Tone.Transport.stop();
          Tone.Transport.cancel();
          playButton.html("play");
        } else {
          Tone.Transport.cancel();
          background("black");
          Tone.Transport.scheduleRepeat(setMelody, "4n");
          Tone.Transport.start();
          playButton.html("stop");
        }
      }

      function setMelody() {
        beat = Tone.Transport.position.split(":")[1];
        let midiNote = Tone.Frequency(melody[beat], "midi");
        synth.triggerAttackRelease(midiNote);
        monoSynth.triggerAttackRelease(midiNote);
      }

      function generateMelody() {
        background("black");
        melody = [];
        beat = 0;
        if (melody.length == numNotes) {
          melody.splice(0, melody.length);
        }
        for (let i = 0; i < numNotes; i++) {
          n = int(random(scale[selectedScale].length));
          note = root + scale[selectedScale][n];
          melody.push(note);
        }
      }
    </script>
  </body>
</html>
